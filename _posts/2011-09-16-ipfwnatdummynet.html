---
layout: post
title: ipfw+nat+dummynet
date: 2011-09-16 14:53:05.000000000 +08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Unix/Linux
tags:
- dummnet
- freebsd
- ipfw
- nat
meta: {}
author:
  login: mcloud
  email: ''
  display_name: mcloud
  first_name: ''
  last_name: ''
---
<p>when someone download file, others can not open the website, so the NAT must be configured.</p>
<p>few days ago, i use the ipfilter,  but it can not work with the dummynet.</p>
<p>so today i learn the ipfw and dummynet ..</p>
<p>1. load the module on kernel (edit /etc/rc.conf)</p>
<p>dhcpd_enable="YES"<br />
dhcpd_ifaces="rl0"<br />
<span style="color:#ff0000;">natd_interface="rl1"</span><br />
<span style="color:#ff0000;">natd_enable="YES"</span><br />
<span style="color:#ff0000;">natd_flag="-dynamic -m"</span><br />
<span style="color:#ff0000;">dummynet_enable="YES"</span><br />
<span style="color:#ff0000;">firewall_enable="YES"</span><br />
<span style="color:#ff0000;">firewall_type="open"</span></p>
<p>2. edit the ipfw(add to the /etc/rc.local) csh scripts</p>
<p>ipfw -q -f flush<br />
cmd="ipfw -q"<br />
${cmd} add 100 divert natd ip from any to any via rl1<br />
${cmd} add 50000 allow ip from any to any<br />
${cmd} pipe 100 config bw 1200KByte/s<br />
${cmd} queue 100 config weight 5 pipe 100 mask dst-ip 0x000000ff<br />
${cmd} add 90 queue 100 ip from any to 192.168.1.0/24</p>
<p>the script of tsh, csh, bash  has compeptive</p>
<p>3. reboot and test</p>
<p>3.1 kldstat  (kldload load the modules)</p>
<p>it can check the modules loadding on kerenl</p>
<p>3.2 sysstat -if</p>
<p>it can moniter the flow on the interface.</p>
